!function(t){"use strict";Vue.component("e-course-section-new",{template:"#tmpl-e-course-section-new",props:["sections"],data:function(){return{section:{title:"",description:"",items:[]}}},watch:{},methods:{sectionClasses:function(){return["e-section new-section placeholder"]},_onKeyPress:function(e){if(13==e.keyCode){e.preventDefault();var i=t.extend({},this.section);i.items=[],this.sections.push(i),Vue.nextTick(function(){this.section.title="",this.section.description="",t(this.$refs.sectionTitle).focus()},this)}}}}),Vue.component("e-course-section",{template:"#tmpl-e-course-section",props:["section","placeholder"],data:function(){return{oldDesc:"",selectedItems:[],status:"",defaultItem:{type:"lp_lesson"}}},$input:null,watch:{"section.title":function(t){this.updateSectionTitle()}},computed:{items:function(){return this.section.items||[]},sortedItems:function(){return this.section.items||[]},itemIds:function(){},countItems:function(){return this.items.length}},mounted:function(){this.$parent.$on("pressTitle",this.onPressTitle),this.$input=t(this.$el).find(".section-title"),this.$input.data("$instance",this),this.$item=null,this.isNew()&&this.focus(),t(this.$el).find(".e-section-content").sortable({axis:"y",handle:".sort svg",connectWith:".e-section-content",items:".e-section-item:not(.placeholder)",start:t.proxy(this._startSort,this),update:t.proxy(this._updateSortable,this)}),window.$section=this,isNaN(this.section.id)&&this.update("title")},methods:t.extend({updateSectionTitle:FE_Helpers.debounce(function(){this.$dispatch("updateSectionTitle",{section_ID:this.section.id,title:this.section.title})},500),onPressTitle:function(e,i){if(t(e.target).is(this.$input))if(13!==i.code)this.onFocus();else if(e.preventDefault(),this.placeholder){var s=t(this.$el).find(".section-title").val();s.length&&(this.$parent.addNewSection(-1,{title:s}).then(function(t){t&&t.update("title")}),FE_Helpers.debounce(function(t){t.$parent.moveNextInput()},100)(this))}else{if(i.ctrl)t(this.$el).find(".item-title").first().focus().length||this.addNewItem();else this.$parent.moveNextInput()}},test:function(){return 456},onFocus:function(){this.focused||(this.focused=!0,this.$emit("onFocusSection",this))},onBlur:function(){this.focused&&(this.focused=!1,this.$emit("onBlurSection",this))},onFocusItem:function(e){this.$item=e;var i=t(e.$el).find(".item-title");t(".item-title").not(i).each(function(){t(this).data("$instance").onBlur(123)})},onBlurItem:function(t){},moveNextInput:function(){var e=t(this.$el).next().find(".section-title").focus();e.length?e.data("$instance").onFocus():this.$parent.addNewSection(this)},focus:function(){var e=t(this.$el).find(".section-title").focus();return!!e.length&&(e.data("$instance").onFocus(),e)},sectionClasses:function(){var t=["e-section"];return this.isNew()&&t.push("new-section"),this.isHidden()&&t.push("closed"),this.placeholder&&t.push("placeholder"),this.status&&t.push(this.status),t},isHidden:function(){return-1!==t.inArray(this.getId()+"",this.$dataStore().admin_hidden_sections)},getId:function(){return this.section.id},addItem:function(e,i){var s=this.items.length,n=null;if(null!=i&&(s=isNaN(i)?this.getItemPosition(i)+1:i),t.isArray(e))for(var o=e.length-1;o>=0;o--)n=e[o],this.section.items.splice(s,0,n);else this.section.items.splice(s,0,e),e=[e];this.$dispatch("addItem",{section_ID:this.section.id,items:e.listPluck("id"),position:s})},addNewItem:function(e,i){var s=this.$dataStore("default_course_item"),n=this.items.length,o=LP.uniqueId(),c=t.extend({},{id:o,type:s,title:"",settings:this.getDefaultItemSettings(s)},i||{});switch(s){case"lp_quiz":c.questions=[]}return e&&(n=isNaN(e)?this.getItemPosition(e)+1:e),this.section.items.splice(n,0,c),FE_Helpers.debounce(function(e){var i=t('[data-id="'+o+'"]').data("$instance");e.maybeUpdateItem(i)},30)(this),this.$emit("added-item",c,this),!!c.title.length},maybeUpdateItem:function(e){var i=this,s=FE_Helpers.clone(e.item),n=this.getItemPosition(e);return s.position=n+1,s.title.length&&this.$dispatch("addNewItem",{section_ID:this.section.id,item:s}).then(t.proxy(function(t){t.new_item&&(e.item.id=t.new_item.id,LP.setUrl(i.$dataStore("coursePermalink")+"/"+e.item.id+"/"))},this)),s.title.length},getItemPosition:function(t){var e=-1;if(t)for(var i in this.section.items)if(this.section.items[i].id==t.getId()){e=parseInt(i);break}return e},defaultType:function(){return this.$dataStore("default_course_item")},getItemIds:function(){var e=[];return t.map(this.section.items,function(t){e.push(t.id)}),e},removeItem:function(e){var i="";i=t.isPlainObject(e)?e.id:e.getId?e.getId():e,t.each(this.section.items,t.proxy(function(t,e){if(e.id==i)return this.section.items.splice(t,1),!1},this))},isNew:function(){return isNaN(this.section.id)},openItemSettings:function(t){this.$emit("openItemSettings",t,this)},getPosition:function(){return t(this.$el).parent().children().index(this.$el)},update:function(e){this.status="updating",this.$store().dispatch("updateSection",{section:this.section,context:e}).then(t.proxy(function(t){t.section_id!==this.section.id&&(this.section.id=t.section_id),this.status=""},this))},updateItemsOrderFromView:function(e){e||(e=t(this.$el).find(".e-section-item")),this.section.items=FE_Helpers.sortArrayByDOM(this.section.items,"","id",e),this.$store().dispatch("updateItemsOrder",{items:this.section.items,section_ID:this.section.id})},isSelectedItem:function(t){return this.selectedItems.findIndex(function(e){return e==t})},getItemIdsFromView:function(){return t(this.$el).find(".e-section-content").children().map(function(){return t(this).attr("data-id")}).get()},getRemovedItems:function(){var t,e,i,s=this.getItemIdsFromView(),n=this.section.items.listPluck("id").diffArray(s),o=[];for(t=0,e=n.length;t<e;t++)i=n[t],o.push({id:n[t],position:this.section.items.findIndex(function(t){return t.id==i})});return o},getAddedItems:function(){var t,e,i,s=this.getItemIdsFromView(),n=s.diffArray(this.section.items.listPluck("id")),o=[];for(t=0,e=n.length;t<e;t++)i=n[t],o.push({id:n[t],position:s.findIndex(function(t){return t==i})});return o},_set:function(){},_toggle:function(e){var i=t(this.$el),s=!i.hasClass("closed");t(e.target).data("mouse_hold_time")>1100?i.parent().children().toggleClass("closed",s):i.toggleClass("closed"),this.$emit("toggle-sections",this)},_toggleDesc:function(){t(this.$el).toggleClass("e-editing-content").hasClass("e-editing-content")?this.oldDesc=this.section.description:this._discardChangeDesc()},_saveDesc:function(t){t.preventDefault(),this.$().removeClass("e-editing-content"),this.$root.$request("","update-course-section",{section_ID:this.section.id,section_description:this.section.description})},_discardChangeDesc:function(t){t&&t.preventDefault(),this.section.description=this.oldDesc,this.$().removeClass("e-editing-content")},_move:function(e,i){var s=!1;t(e.target).data("mouse_hold_time")>1100&&(s=!0),this.$emit("move-section",[this,i,s])},_moveItem:function(e){var i=e[0],s=e[1],n=t(this.$el).find('.e-section-item[data-id="'+i.item.id+'"]'),o=n.parent().children(),c=null;(c="up"===s?e[2]?o.first():n.prev():e[2]?o.last():n.next()).length&&("up"===s?n.insertBefore(c):n.insertAfter(c),this.updateItemsOrderFromView(n.parent().children()))},_startSort:function(t,e){e.item.data("$parent",t.target)},_updateSortable:function(t,e){this.$dataStore("tempSections")||this.$dataStore("tempSections",[-1,-1]),e.sender?this.$dataStore("tempSections")[1]=this:this.$dataStore("tempSections")[0]=this,this._updateTowSections()},_updateTowSections:FE_Helpers.debounce(function(e){var i=this.$dataStore("tempSections");if(-1!==i[0]&&-1===i[1])i[0].updateItemsOrderFromView();else if(-1!==i[0]&&-1!==i[1]){var s,n,o,c,r=i[0],d=i[1],a=r.getRemovedItems(),h=d.getAddedItems(),u=null;for(s=0,o=a.length;s<o;s++)for(u=r.section.items[a[s].position],n=0,c=h.length;n<c;n++)if(h[n].id==a[s].id){t(d.$el).find('.e-section-item[data-id="'+u.id+'"]').remove(),d.addItem(u,h[n].position);break}}this.$dataStore("tempSections",!1)},200),_addNewSection:function(e){t(e.target).data("mouse_hold_time")>1100?this._addItems():this.$emit("add-new-section",[e,this])},_deleteSection:function(e){if(confirm(FE_Localize.get("confirm_delete_section"))){this.status="removing";var i=!1;t(e.target).data("mouse_hold_time")>1100&&confirm(FE_Localize.get("confirm_trash_items_with_section"))&&(i=!0),this.$emit("delete-section",[e,i,this])}},_deleteItem:function(t){var e=t[0],i=!1,s=null;if(-1!==this.isSelectedItem(e)&&(e=this.selectedItems,i=!0),t[1]||i){if(s=t[1]&&i?FE_Localize.get("confirm_trash_items"):i?FE_Localize.get("confirm_delete_items"):FE_Localize.get("confirm_trash_item"),!confirm(s))return;i&&(this.selectedItems=[])}else if(!confirm(FE_Localize.get("confirm_remove_course_item")))return;this.items.findIndex(function(t){return t.id==e});this.$emit("delete-item",{id:e,section_ID:this.section.id}),this.$store().dispatch("deleteItem",{item_ID:e,section_ID:this.section.id,trash:t[1]?"yes":"no"})},_startAnim:function(e){t(e.target).addClass("anim")},_stopAnim:function(e){t(e.target).removeClass("anim")},_selectItem:function(t){var e=this.isSelectedItem(t[1].item.id);-1===e?this.selectedItems.push(t[1].item.id):this.selectedItems.splice(e,1)},_deselectItem:function(){this.selectedItems=[]},_addItems:function(t){var e=null;t&&t[1]&&(e=t[1]),this.$root.openModelSelectItems({context:this,postTypes:this.$dataStore("course_item_types"),screen:"lp_course",screenID:this.$dataStore().course_ID,select:function(t){if(t.items){var i=FE_Helpers.clone(t.items);this.addItem(i,e)}},exclude:function(){return this.$root.getItemIds()}})}},FE_Base.Store_Methods)})}(jQuery);