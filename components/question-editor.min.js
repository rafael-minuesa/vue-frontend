!function(e){var t={template:"#tmpl-e-question",props:["question","itemData"],data:function(){return{newID:0,redraw:!0,checkedAnswer:"",showSettingsBox:!1}},watch:{checkedAnswer:function(e){return this._setCheckAnswer(e),e}},computed:{answers:{get:function(){var e=this.question.answers;return e&&0!==e.length||(e=[{id:LP.uniqueId(),question_answer_id:LP.uniqueId(),value:LP.uniqueId(),text:""}]),e},set:function(e){this.question.answers=e}}},mounted:function(){var t,n=["title","content"];for(t=0;t<n.length;t++)this.$watch("question."+n[t],function(e,t){return function(n){e.watchChangeQuestion(t,n)}}(this,n[t]));e(this.$el).find(".e-question-answers").sortable({handle:".sort",axis:"y",update:e.proxy(function(t,n){this.$set(this.question,"answers",FE_Helpers.sortArrayByDOM(this.answers,"answer_order","question_answer_id",e(t.target).children())),this._redraw()},this)}),e("#e-item-settings").addClass("editing-question").find(".e-item-settings-content").scrollTop(0),window["FE_Question_"+this.question.id]=this},methods:e.extend({},FE_Base.Store_Methods,{watchChangeQuestion:FE_Helpers.debounce(function(e,t){var n={id:this.question.id};n[e]=t,this.$dispatch("updateQuestion",{quiz_ID:this.itemData.id,context:e,question:n}).then(function(e){e.result})},1e3,this),countAnswers:function(){return this.answers?this.answers.length:0},getQuestionIndex:function(){var e=this,t=(this.itemData?this.itemData.questions.findIndex(function(t){return t.id===e.question.id}):0)+1;return t<10?"0"+t:t},_redraw:function(){this.redraw=!1,this.$nextTick(function(){this.redraw=!0})},edit:function(){this.$emit("edit-question",this)},getDataStore:function(){return this.$root.$store()},setDefaultCheckedAnswer:function(){for(var e=0,t=this.answers.length;e<t;e++)if("yes"===this.answers[e].is_true)return;this.answers[0].is_true="yes"},getAnswerIndex:function(e){return this.answers.findIndex(function(t){return t.question_answer_id==e})},isSupport:function(e){var t=this.question.type,n=this.$dataStore().question_types.find(function(e){return e.type==t});return!(!n||!n.supports)&&n.supports[e]},_addAnswer:function(e,t){var n=this.getAnswerIndex(t);this.addAnswer(-1!==n?n+1:null)},_add:function(){},_deleteAnswer:function(e,t){if(!(2>=this.countAnswers())){var n=this.getAnswerIndex(t);if(-1!==n){if("yes"===this.answers[n].is_true&&!confirm(FE_Localize.get("confirm_delete_checked_answer")))return;this.answers.splice(n,1),this.setDefaultCheckedAnswer(),this.updateQuestionAnswers()}}},_back:function(e){e.preventDefault(),this.$parent._closeQuestion(e)},_setCheckAnswer:function(t){var n=e(t.target).closest(".e-question-answers").find("input.e-answer-check-input");if(n.filter(":checked").length||confirm(FE_Localize.get("question_require_at_least_checked_answer")))if(n.filter(":checked").length!==n.length||confirm(FE_Localize.get("question_have_all_answer_checked"))){for(var i=0,s=n.length;i<s;i++)this.answers[i].is_true=n[i].checked?"yes":"no";this.updateQuestionAnswers()}else t.target.checked=!1;else t.target.checked=!0},_onBlurAnswerInput:function(e){this.updateQuestionAnswers()},updateQuestionAnswers:FE_Helpers.debounce(function(){var t=this;this.$dispatch("updateQuestion",{quiz_ID:this.itemData.id,context:"update-answers",question:{id:this.question.id,answers:this.answers}}).then(function(n){"success"===n.result&&n.question_answer_ids&&e.each(t.question.answers,function(e,i){void 0!==n.question_answer_ids[i.question_answer_id]&&(t.question.answers[e].question_answer_id=n.question_answer_ids[i.question_answer_id])})})},1e3),answerClass:function(e){var t=["e-question-answer e-sort-item"];return(e.question_answer_id<=0||isNaN(e.question_answer_id))&&t.push("new-item"),t},getAnswerCheckType:function(){var e="checkbox";return this.isSingleChoice()&&(e="radio"),e},isSingleChoice:function(){return-1!==e.inArray(this.question.type,["true_or_false","single_choice"])},isCheckedAnswer:function(e){return"yes"===e.is_true},addAnswer:function(t){if(t=parseInt(t),this.isSupport("add_answer")){this.answers||(this.answers=[]),(t<0||isNaN(t))&&(t=this.answers.length),this.newID=LP.uniqueId();var n={question_answer_id:this.newID,question_id:this.question.id,answer_order:t,text:"",value:this.newID,is_true:"no"};this.answers.splice(t,0,n),e(this.$el).find(".e-question-answers .new-item").addClass("paused"),this.$nextTick(function(){this.focusNewAnswer(),e(this.$el).find(".e-question-answers .new-item").removeClass("paused")})}},getAnswerIndexLabel:function(e){return void 0!==e?e+".":""},focusNewAnswer:function(){e(this.$el).find('[data-id="'+this.newID+'"] .e-question-answer-input').focus()},onKeydown:function(t){var n=FE_Helpers.getKeyboard(t),i=e(t.target).closest(".e-question-answer"),s=i.parent().children(),r=s.index(i);switch(n.code){case 13:t.preventDefault(),t.target.value.length&&this.addAnswer(r+1);break;case 38:case 40:t.preventDefault(),38===n.code?0===r?r=s.length-1:r--:r===s.length-1?r=0:r++,s.eq(r).find(".e-question-answer-input").focus()}},getPrevQuestionIndex:function(e){var t=this,n=this.itemData.questions.findIndex(function(e){return e.id==t.question.id}),i=n>0?n:0;return e&&i<10?"0"+i:i},getNextQuestionIndex:function(e){var t=this,n=this.itemData.questions.findIndex(function(e){return e.id==t.question.id}),i=n<this.itemData.questions.length-1?n+2:0;return e&&i<10?"0"+i:i},getPrevQuestionTitle:function(){var e=this.getPrevQuestionIndex();return 0==e?"":this.itemData.questions[e-1].title},getNextQuestionTitle:function(){var e=this.getNextQuestionIndex();return 0==e?"":this.itemData.questions[e-1].title},getQuestionAnswersComponent:function(){return e(document).triggerHandler("FE.question-answers-component",this.question)},_loadQuestion:function(t,n){t.preventDefault();var i=-1;switch(n){case"prev":i=this.getPrevQuestionIndex();break;default:i=this.getNextQuestionIndex()}this.$emit("load-question",i-1,"position"),e(this.$el).scrollTop(0)}})};Vue.component("e-question",{mixins:[t]}),e(document).on("FE.question-answers-component",function(e,t){if("fill_in_blank"===t.type)return"fib-question-answers"}),Vue.component("fib-question-answers",{template:"#tmpl-fib-question-answers",props:["question"],data:function(){return{valid:!0,canInsertNewBlank:!1,blanks:[]}},computed:{answer:function(){return{answer_order:1,is_true:"",question_answer_id:this.answers[0].question_answer_id,text:this.answers[0].text,value:""}},answers:function(){return this.answers}},mounted:function(){var t=this,n=this.getContent();this.blanks=this.answers[0].blanks||[],this.$editor=e(this.$el).find(".content-editable"),this.$editor.html(n),this.parseBlanks(n),this.$editor[0].addEventListener("DOMCharacterDataModified",function(n){var i=e(n.target).parent(),s=i.data("id");for(var r in t.blanks)if(t.blanks[r].id==s){t.blanks[r].fill=i.html().trim(),t.$activeBlank=i;break}},!1)},methods:{updateAnswer:FE_Helpers.debounce(function(){this.parseBlanks();var e=JSON.parse(JSON.stringify(this.answer));e.text=this.getShortcode(),e.blanks=this.getBlanksForDB(),FE_Helpers.Course_Editor_Request("","e_ajax_update_fib",{question_id:this.question.id,answer:e}).then(function(e){})},1e3,this),updateAnswerBlank:function(e,t){this.updateAnswer()},getContent:function(){var e=this.answers[0].text,t=e.match(/\[fib.*?\]/g),n={};if(t)for(var i=0;i<t.length;i++){var s,r,a,o=t[i].match(/([a-z_]+)="(.*?)"/g),u=[];for(var d in o)if(o.hasOwnProperty(d)){var h=o[d].match(/([a-z_]+)="(.*?)"/);if(h)switch(h[1]){case"uid":case"id":s=h[2];break;case"fill":r=h[2];break;default:u.push("data-"+h[1]+'="'+h[2]+'"')}}n[s=s||LP.uniqueId()]&&(s=LP.uniqueId()),a=FIB.outerHTML(this.createBlank(r,s).attr("data-index",i+1)),n[s]=!0,e=e.replace(t[i],a)}return e},activeBlank:function(t){this.$activeBlank=e(t.target).closest(".fib-blank")},findBlank:function(e){for(var t in this.blanks)if(this.blanks[t].id==e)return this.blanks[t];return!1},parseBlanks:function(t){var n,i,s=this.$editor.find(".fib-blank"),r=[],a=[],o=0;for(o=0;o<s.length;o++){i=(n=s.eq(o).attr("data-index",o+1)).data(),-1!==e.inArray(i.id,a)&&(i.id=LP.uniqueId());var u=this.findBlank(i.id)||{};r.push({fill:n.html().trim(),id:i.id,comparison:i.comparison||u.comparison||"",match_case:i.match_case||u.match_case||0,index:o+1,open:!!u.open}),a.push(i.id)}this.blanks=r},updateBlanks:function(e){return this.parseBlanks(void 0!==e?e:this.$editor.html()),this.getShortcode()},getShortcode:function(){var t=this,n=this.$editor.clone();return n.find(".fib-blank").each(function(){var n=e(this),i=n.attr("id").replace("fib-blank-",""),s=t.getBlankById(i),r="fib";if(s){if(!s.id)return;for(var a in s)-1===e.inArray(a,["index"])&&s[a]&&(r+=" "+a+'="'+s[a]+'"');n.replaceWith("["+r+"]")}else console.log("Not found: "+i),n.replaceWith("")}),n.html()},getBlankById:function(t){var n=!1;return e.each(this.blanks,function(){if(t==this.id)return n=this,!0}),n},updateBlank:function(t){var n=e(t.target).attr("id");this.$editor.find("#"+n).html(t.target.value),this.updateAnswer()},removeBlank:function(e,t){e.preventDefault(),this.removeBlankById(t),this.updateAll()},removeBlankById:function(e){var t=this.$editor.find(".fib-blank#fib-blank-"+e);t.replaceWith(t.html())},updateAll:function(){this.answer.text=this.updateBlanks(),this.updateAnswer()},insertBlank:function(){if(this.canInsertNewBlank){var t=e(this.$el).find(".content-editable"),n=(t.html(),FIB.getSelectedText()),i=FIB.getSelectionRange(),s=this.createBlank(n),r=i.anchorNode.nodeValue,a=i.anchorOffset,o=a+n.length;i.anchorNode.nodeValue=r.substr(0,a),e(s).insertAfter(i.anchorNode),e(FIB.createTextNode(r.substr(o))).insertAfter(s),t.find(".fib-blank").each(function(t,n){e(this).attr("data-index",t+1)}),this.parseBlanks(t.html()),this.updateAnswer()}},createBlank:function(t,n){return n||(n=LP.uniqueId()),e('<b class="fib-blank" id="fib-blank-'+n+'" data-id="'+n+'"> '+t+"</b>")},clearBlanks:function(){if(confirm($store.getters["i18n/all"].confirm_remove_blanks)){for(var e in this.blanks)this.removeBlankById(this.blanks[e].id);this.updateAll()}},clearContent:function(){this.$editor.html(""),this.updateAnswer()},canInsertBlank:function(){e(this.$el).find(".content-editable").html();var t=FIB.getSelectedText(),n=FIB.getSelectionRange();this.canInsertNewBlank=t.length&&!FIB.isContainHtml(n.anchorNode)},getBlanksForDB:function(){for(var e={},t=0,n=this.blanks.length;t<n;t++){var i=this.blanks[t].id.replace("fib-blank-","");e[i]=JSON.parse(JSON.stringify(this.blanks[t])),e[i].id=i}return e},toggleOptions:function(t,n){t.preventDefault();var i=this;e(t.target).closest(".fib-blank").find(".blank-options ul").slideToggle(function(){i.setBlankProp(n,"open",!e(this).is(":hidden"))})},setBlankProp:function(t,n,i){for(var s in this.blanks)if(this.blanks[s].id==t){if(e.isPlainObject(n))for(var r in n)this.$set(this.blanks[s],r,n[r]);else this.$set(this.blanks[s],n,i);break}this.updateAnswer()}}})}(jQuery);