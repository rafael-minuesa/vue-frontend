!function(t){"use strict";Vue.component("e-question-loop",{template:"#tmpl-e-question-loop",props:["question","hidden","index","itemData","key","placeholder"],watch:{question:{handler:function(){},deep:!0},"question.settings":{handler:function(t){this.updateQuestionSettings()},deep:!0}},computed:{questionMark:{get:function(){return this.question.settings?this.question.settings._lp_mark:1},set:function(t){this.question.settings._lp_mark=t}},answers:{get:function(){var t=this.question.answers;return t&&0!==t.length||(t=[{id:LP.uniqueId(),question_answer_id:LP.uniqueId(),value:LP.uniqueId(),text:""}]),t},set:function(t){this.question.answers=t}}},mounted:function(){this.placeholder&&(this.question.title="",t(this.$refs.questionTitle).focus())},methods:t.extend(FE_Base.Store_Methods,{edit:function(){this.$emit("edit-question",this)},updateQuestionSettings:FE_Helpers.debounce(function(){this.$dispatch("updateQuestionSettings",{question_ID:this.question.id,settings:this.question.settings}).then(function(t){})},300,this),watchQuestionSettingsChange:function(t,e){},watchQuestionChange:function(t,e){},getTypeName:function(){var t=this.question.type,e=this.$dataStore("question_types").find(function(e){return e.type==t});return e?e.name:""},questionClass:function(){var t=["e-question-loop e-sort-item "+this.question.type];return isNaN(this.question.id)&&t.push("new-item"),this.placeholder&&t.push("placeholder"),t},getQuestionIndexLabel:function(){return void 0!==this.index?this.index+1+".":""},countQuestions:function(){var e,i=this.answers?this.answers.length:0;return void 0!==(e=t(document).triggerHandler("FE.count-question-answers",[i,this]))&&(i=e),i},isNew:function(){return this.question.id&&isNaN(this.question.id)||!this.question.id},_onKeydown:function(t){13!==t.keyCode||(t.target.value+"").length?this.$emit("press-question-title",[t,this]):t.preventDefault()},_switch:function(e){var i=this,s=t(e.target),n=s.closest("ul"),o=this.question.type,u=s.attr("data-type");n.hide(),FE_Helpers.debounce(function(){n.css("display","")},300)(),this.$emit("change-question-type",u),this.placeholder?this.question.type=u:confirm(FE_Localize.get("confirm_change_question_type"))&&(this.question.type=u,this.$dispatch("changeQuestionType",{quiz_ID:this.itemData.id,question:{id:this.question.id,oldType:o,newType:u}}).then(function(t){t.answers&&Vue.set(i.question,"answers",t.answers)}))},_onBlur:function(t){this.$emit("update-question-title",{context:"title",event:t,$vm:this})},_delete:function(e){var i=!1;t(e.target).data("mouse_hold_time")>1100&&(i=!0),(i?confirm(FE_Localize.get("confirm_trash_question_in_quiz")):confirm(FE_Localize.get("confirm_remove_question_in_quiz")))&&this.$emit("delete-question",e,i,this)}})}),Vue.component("e-quiz-editor",{template:"#tmpl-e-quiz-editor",props:["section","item","itemData"],data:function(){return{editID:-1,question:null,hidden:!1,newQuestionID:-1,defaultQuestion:{title:"",type:"",answers:[]}}},computed:{questions:{get:function(){return this.itemData.questions||[]},set:function(t){this.itemData.questions=t}}},watch:{},created:function(){this.defaultQuestion.type=this.$dataStore("question_types")[0].type,this.itemData.questions||(Vue.set(this.itemData,"questions",[]),this.questions=[])},mounted:function(){var e=this;t(document).on("e-item-settings",function(t,i){return"lp_quiz"===i.__type&&(i.questions=e.itemData.questions),i}),this.makeSortable();var i=[];t(document).on("keyup",function(s){if(t(s.target).is("input, select, textarea"))i=[];else if(i.push(s.key.toLowerCase()),i.length>1){var n=!0;switch(i.slice(-2).join("")){case"cq":e.addQuestion();break;case"eq":e.question=e.questions[0],e.editID=e.question.id;break;default:n=!1}n&&(i=[])}})},methods:t.extend({},FE_Base.Store_Methods,{makeSortable:function(){t(this.$el).find(".e-questions").sortable({handle:".sort",axis:"y",items:".e-question-loop:not(.placeholder)",update:t.proxy(function(e,i){this.itemData.questions=FE_Helpers.sortArrayByDOM(this.questions,"order","id",t(e.target).children()),this.$dispatch("updateQuestionsOrder",{quiz_ID:this.itemData.id,questions:this.itemData.questions.listPluck("id")}),this.redraw()},this)})},redraw:function(){this.hidden=!0,this.$nextTick(function(){this.hidden=!1,this.$nextTick(function(){this.makeSortable()})})},getQuestions:function(){return this.questions},_addNew:function(){this.addQuestion()},editQuestion:function(t){this.editID=t.question.id,this.question=t.question,this.$emit("edit-question",this.question)},isEditingQuestion:function(){return-1!==this.editID},close:function(e){e.preventDefault(),this.editID=-1,this.$emit("edit-question",null),t("#e-item-settings").removeClass("editing-question")},update:function(t){t.preventDefault(),this.$root.$request("","update-question",{quiz_ID:this.itemData.id,question:this.question}).then(function(t){})},addQuestion:function(e,i){this.questions||(this.questions=[]),void 0===e&&(e=this.questions.length);var s=this.$dataStore("question_types").random();this.newQuestionID=LP.uniqueId();var n=t.extend({id:this.newQuestionID,title:"",settings:this.getDefaultItemSettings("lp_question"),type:s.type,answers:[]},i||{});this.questions.splice(e,0,n),Vue.set(this.itemData,"questions",this.questions),t(".e-question-loop.new-item").addClass("paused"),this.$nextTick(function(){this.focusNewQuestion(),t(".e-question-loop.new-item").removeClass("paused"),1===this.questions.length&&(this.redraw(),this.$(".question-loop-title").val("").focus())})},addQuestions:function(e,i){var s=this.questions.length,n=null,o=this.getDefaultQuestionData();if(i&&(s=this.getQuestionPosition(i)+1),t.isArray(e))for(var u=e.length-1;u>=0;u--)n=t.extend({},o,{id:e[u].id,title:e[u].title,type:e[u].type}),this.questions.splice(s,0,n);else this.questions.splice(s,0,t.extend({},o,{id:e.id,title:e.title,type:e.type})),e=[e];this.$dispatch("addQuestions",{quiz_ID:this.itemData.id,questions:e.listPluck("id")}).then(t.proxy(function(t){if(t.questions)for(var e="",i=0,s=this.questions.length;i<s;i++)e=this.questions[i].id,void 0!==t.questions[e]&&(this.questions[i].answers=t.questions[e].answers,this.questions[i].type=t.questions[e].type)},this))},getDefaultQuestionData:function(){return{id:0,content:"",answers:[],type:"single_choice",order:0}},getQuestionPosition:function(t){var e=-1;if(t)for(i in this.questions)if(this.questions[i].id==t.question.id){e=parseInt(i);break}return e},focusNewQuestion:function(){t(this.$el).find('[data-id="'+this.newQuestionID+'"] .question-loop-title').focus()},_onKeydownQuestionTitle:function(e){var i=FE_Helpers.getKeyboard(e[0]),s=t(e[0].target).closest(".e-question-loop"),n=s.parent().children(),o=n.index(s);switch(i.code){case 13:if(e[0].preventDefault(),!e[1].question.title)return;e[1]&&e[1].placeholder?(this.addQuestion(o+1,{title:e[1].$(".question-loop-title").val(),type:e[1].question.type}),FE_Helpers.debounce(function(t){e[1].$(".question-loop-title").val("").focus()},30)(e[1])):this.addQuestion(o+1);break;case 38:case 40:e[0].preventDefault(),38===i.code?0===o?o=n.length-1:o--:o===n.length-1?o=0:o++,n.eq(o).find(".question-loop-title").focus()}},_select:function(t){var e=null;t&&t[1]&&(e=t[1]),this.$root.openModelSelectItems({context:this,postTypes:[{type:"lp_question",name:"Questions"}],screen:"lp_quiz",screenID:this.itemData.id,selectButton:FE_Localize.get("modal_select_question_button"),modalTitle:FE_Localize.get("modal_select_question_title"),select:function(t){if(t.items){var i=FE_Helpers.clone(t.items);this.addQuestions(i,e)}},exclude:function(){return this.questions.listPluck("id")}})},_updateQuestion:function(t){t.$vm.question;this.$dispatch("updateQuestion",{quiz_ID:this.itemData.id,context:t.context,question:t.$vm.question}).then(function(e){"success"===e.result&&e.id&&t.$vm.question.id!==e.id&&(t.$vm.question.id=e.id,Vue.set(t.$vm.question,"answers",e.answers||[]))})},_onDeleteQuestion:function(t,e,i){var s=this;this.$dispatch("removeQuestion",{quiz_ID:this.itemData.id,question_ID:i.question.id,trash:e}).then(function(t){if("success"===t.result&&t.question_ID){var e=s.questions.findIndex(function(e){return e.id==t.question_ID});s.questions.splice(e,1)}})},_changeDefaultQuestionType:function(t){this.defaultQuestion.type=t},_addNewQuestion:function(t){this.addQuestion(this.questions.length+1,t)},loadQuestion:function(t,e){}})})}(jQuery);